<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Smart Station Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles -->
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .mix-blend-multiply { mix-blend-mode: multiply; }
        
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Offline Visuals - Reduced intensity so it doesn't look disabled */
        .system-offline-overlay {
            opacity: 0.9;
            filter: grayscale(60%);
            transition: all 0.5s ease;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans pb-10 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-slate-900 text-white shadow-xl sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-r from-blue-500 to-cyan-400 p-2 rounded-lg">
                    <i data-lucide="battery-charging" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold tracking-tight">EV Smart Station</h1>
                    <p class="text-xs text-slate-400">Real-time 18650 Monitoring</p>
                </div>
            </div>
            <!-- Connection Badge -->
            <div id="connection-badge" class="flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold border bg-rose-500/20 border-rose-500/50 text-rose-400 transition-all duration-300">
                <i data-lucide="wifi-off" class="w-3.5 h-3.5" id="connection-icon"></i>
                <span id="connection-text">CONNECTING...</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 transition-all duration-500">
        
        <!-- Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <!-- Left Column: Charging Slots -->
            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- SLOT 1 CARD -->
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border-t-4 border-blue-500 transition-all hover:shadow-2xl flex flex-col justify-between">
                    <div>
                        <!-- Header -->
                        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600 font-black">1</div>
                                Station A
                            </h2>
                            <!-- AUTH STATUS BADGE -->
                            <div id="s1-auth-badge" class="hidden px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide"></div>
                        </div>

                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Battery Graphic -->
                                <div class="flex flex-col items-center justify-center bg-slate-50 rounded-xl p-2 border border-slate-100">
                                    <div class="relative w-full flex flex-col items-center justify-center py-4">
                                        <div class="relative w-24 h-40 border-4 border-slate-700 rounded-xl bg-slate-200 overflow-hidden shadow-inner">
                                            <div id="s1-bat-fill" class="absolute bottom-0 left-0 right-0 bg-emerald-500 transition-all duration-1000 ease-out flex items-center justify-center" style="height: 0%">
                                                <div id="s1-charge-icon" class="animate-pulse text-white opacity-50 hidden">
                                                    <i data-lucide="zap" class="w-8 h-8" fill="currentColor"></i>
                                                </div>
                                            </div>
                                            <div class="absolute inset-0 flex flex-col items-center justify-center z-10 mix-blend-multiply">
                                                <span class="text-3xl font-black text-slate-800"><span id="s1-soc">0</span>%</span>
                                            </div>
                                        </div>
                                        <div class="w-10 h-2 bg-slate-700 rounded-t-md -mt-42 mb-1"></div>
                                        <div class="mt-3 text-center">
                                            <span class="px-2 py-1 bg-slate-100 rounded text-xs font-mono text-slate-600 border border-slate-200">
                                                <span id="s1-volts">0.0</span> V
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Metrics -->
                                <div class="grid grid-cols-1 gap-3">
                                    <div class="flex items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                                        <div class="p-2 rounded-full bg-amber-500 bg-opacity-10 mr-3 text-amber-600"><i data-lucide="zap" class="w-5 h-5"></i></div>
                                        <div>
                                            <p class="text-xs text-slate-500 uppercase font-bold tracking-wider">Power</p>
                                            <p class="text-lg font-semibold text-slate-800"><span id="s1-power">0</span> W</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                                        <div class="p-2 rounded-full bg-violet-500 bg-opacity-10 mr-3 text-violet-600"><i data-lucide="activity" class="w-5 h-5"></i></div>
                                        <div>
                                            <p class="text-xs text-slate-500 uppercase font-bold tracking-wider">Current</p>
                                            <p class="text-lg font-semibold text-slate-800"><span id="s1-current">0</span> A</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Physical Status Badge -->
                                    <div id="s1-status-badge" class="mt-2 text-center px-3 py-2 rounded-lg text-xs font-bold uppercase tracking-wide bg-slate-100 text-slate-500">
                                        <i data-lucide="loader" class="w-3.5 h-3.5 animate-spin inline"></i> <span>Init...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BOOKING CONTROLS SLOT 1 -->
                    <!-- Added pointer-events-auto to ensure clicks work even if parent is "offline" -->
                    <div class="p-4 bg-slate-50 border-t border-slate-100 pointer-events-auto">
                        <div id="s1-booking-panel">
                            <button onclick="window.bookSlot('Slot1')" id="s1-book-btn" class="w-full py-2.5 rounded-lg font-bold text-sm shadow-sm transition-all flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white active:scale-95">
                                <i data-lucide="calendar-clock" class="w-4 h-4"></i> Book Slot 1
                            </button>
                            <p id="s1-booking-msg" class="text-xs text-center mt-2 text-slate-400">Reserve this station for charging</p>
                        </div>
                    </div>
                </div>

                <!-- SLOT 2 CARD -->
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border-t-4 border-blue-500 transition-all hover:shadow-2xl flex flex-col justify-between">
                    <div>
                        <!-- Header -->
                        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600 font-black">2</div>
                                Station B
                            </h2>
                            <!-- AUTH STATUS BADGE -->
                            <div id="s2-auth-badge" class="hidden px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide"></div>
                        </div>

                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Battery Graphic -->
                                <div class="flex flex-col items-center justify-center bg-slate-50 rounded-xl p-2 border border-slate-100">
                                    <div class="relative w-full flex flex-col items-center justify-center py-4">
                                        <div class="relative w-24 h-40 border-4 border-slate-700 rounded-xl bg-slate-200 overflow-hidden shadow-inner">
                                            <div id="s2-bat-fill" class="absolute bottom-0 left-0 right-0 bg-emerald-500 transition-all duration-1000 ease-out flex items-center justify-center" style="height: 0%">
                                                <div id="s2-charge-icon" class="animate-pulse text-white opacity-50 hidden">
                                                    <i data-lucide="zap" class="w-8 h-8" fill="currentColor"></i>
                                                </div>
                                            </div>
                                            <div class="absolute inset-0 flex flex-col items-center justify-center z-10 mix-blend-multiply">
                                                <span class="text-3xl font-black text-slate-800"><span id="s2-soc">0</span>%</span>
                                            </div>
                                        </div>
                                        <div class="w-10 h-2 bg-slate-700 rounded-t-md -mt-42 mb-1"></div>
                                        <div class="mt-3 text-center">
                                            <span class="px-2 py-1 bg-slate-100 rounded text-xs font-mono text-slate-600 border border-slate-200">
                                                <span id="s2-volts">0.0</span> V
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Metrics -->
                                <div class="grid grid-cols-1 gap-3">
                                    <div class="flex items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                                        <div class="p-2 rounded-full bg-amber-500 bg-opacity-10 mr-3 text-amber-600"><i data-lucide="zap" class="w-5 h-5"></i></div>
                                        <div>
                                            <p class="text-xs text-slate-500 uppercase font-bold tracking-wider">Power</p>
                                            <p class="text-lg font-semibold text-slate-800"><span id="s2-power">0</span> W</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                                        <div class="p-2 rounded-full bg-violet-500 bg-opacity-10 mr-3 text-violet-600"><i data-lucide="activity" class="w-5 h-5"></i></div>
                                        <div>
                                            <p class="text-xs text-slate-500 uppercase font-bold tracking-wider">Current</p>
                                            <p class="text-lg font-semibold text-slate-800"><span id="s2-current">0</span> A</p>
                                        </div>
                                    </div>
                                    
                                     <!-- Physical Status Badge -->
                                     <div id="s2-status-badge" class="mt-2 text-center px-3 py-2 rounded-lg text-xs font-bold uppercase tracking-wide bg-slate-100 text-slate-500">
                                        <i data-lucide="loader" class="w-3.5 h-3.5 animate-spin inline"></i> <span>Init...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <!-- BOOKING CONTROLS SLOT 2 -->
                     <!-- Added pointer-events-auto here too -->
                     <div class="p-4 bg-slate-50 border-t border-slate-100 pointer-events-auto">
                        <div id="s2-booking-panel">
                            <button onclick="window.bookSlot('Slot2')" id="s2-book-btn" class="w-full py-2.5 rounded-lg font-bold text-sm shadow-sm transition-all flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white active:scale-95">
                                <i data-lucide="calendar-clock" class="w-4 h-4"></i> Book Slot 2
                            </button>
                            <p id="s2-booking-msg" class="text-xs text-center mt-2 text-slate-400">Reserve this station for charging</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Stats & Logs -->
            <div class="flex flex-col gap-6">
                
                <!-- Session Counter -->
                <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl shadow-lg p-6 text-white relative overflow-hidden">
                    <div class="absolute top-0 right-0 opacity-10 transform translate-x-4 -translate-y-4">
                        <i data-lucide="users" class="w-32 h-32"></i>
                    </div>
                    <div class="relative z-10">
                        <h3 class="text-blue-100 font-medium mb-2 flex items-center gap-2">
                            <i data-lucide="users" class="w-5 h-5"></i> Active Users
                        </h3>
                        <div class="flex items-baseline gap-2">
                            <span id="session-count" class="text-5xl font-bold">0</span>
                            <span class="text-blue-200 text-sm">Authenticated</span>
                        </div>
                        <div class="mt-4 h-1 w-full bg-blue-900/30 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-400 animate-pulse w-2/3"></div>
                        </div>
                    </div>
                </div>

                <!-- RFID Log -->
                <div class="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden flex flex-col flex-1 min-h-[300px]">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2">
                            <i data-lucide="history" class="w-4 h-4 text-slate-400"></i> Access Log
                        </h3>
                        <span id="log-count" class="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded-full">0 Events</span>
                    </div>
                    <div id="rfid-log-container" class="overflow-y-auto p-0 max-h-[300px]">
                        <div class="p-8 text-center text-slate-400 text-sm italic">
                            Waiting for RFID scans...
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-slate-400 text-sm mt-12">
            <p>© 2025 EV Smart Station System • Powered by ESP32 & Firebase</p>
        </div>
    </main>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        // Using stable Firebase version 10.8.0 to ensure prompts work correctly
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDDWy_6FbRAfr7DdHNUeWXfL7iYkL1-Xa0",
            authDomain: "ev-station-b57b1.firebaseapp.com",
            projectId: "ev-station-b57b1",
            storageBucket: "ev-station-b57b1.firebasestorage.app",
            messagingSenderId: "601772739558",
            appId: "1:601772739558:web:d7439ed8bd24479df76427",
            measurementId: "G-THKSGK2H9Z"
        };

        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Initial Icon Render
        lucide.createIcons();

        // State
        let lastUid = "";
        let logCount = 0;
        const MAX_LOGS = 20;
        const VOLTAGE_THRESHOLD = 0.5; 
        
        // --- HEARTBEAT & OFFLINE DETECTION ---
        let lastHeartbeatTime = 0;
        const OFFLINE_THRESHOLD_MS = 15000; 

        const connectionBadge = document.getElementById('connection-badge');
        const connectionText = document.getElementById('connection-text');
        const connectionIcon = document.getElementById('connection-icon');
        const mainContent = document.getElementById('main-content');

        onValue(ref(db, '/EV/Heartbeat'), (snap) => {
            if(snap.exists()) {
                lastHeartbeatTime = Date.now();
                updateOnlineStatus(true);
            }
        });

        function updateOnlineStatus(isOnline) {
            if (isOnline) {
                connectionBadge.className = "flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold border transition-all duration-300 bg-emerald-500/20 border-emerald-500/50 text-emerald-400";
                connectionText.textContent = "DEVICE ONLINE";
                connectionIcon.setAttribute('data-lucide', 'wifi');
                mainContent.classList.remove('system-offline-overlay');
            } else {
                connectionBadge.className = "flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold border transition-all duration-300 bg-rose-500/20 border-rose-500/50 text-rose-400 animate-pulse";
                connectionText.textContent = "DEVICE OFFLINE";
                connectionIcon.setAttribute('data-lucide', 'wifi-off');
                // Added check to ensure this class exists in CSS without pointer-events: none
                mainContent.classList.add('system-offline-overlay'); 
            }
            lucide.createIcons();
        }

        setInterval(() => {
            const timeSinceLastBeat = Date.now() - lastHeartbeatTime;
            if (timeSinceLastBeat > OFFLINE_THRESHOLD_MS) {
                updateOnlineStatus(false);
            }
        }, 2000);


        // --- UI UPDATERS ---

        const updateSlot = (idPrefix, data, slotName) => {
            // Default empty data object to prevent crashes if slot doesn't exist yet
            if(!data) data = {};

            // --- AUTH STATUS BADGE (Hardware Response) ---
            const authStatus = data.AuthStatus; // AUTHORIZED, DENIED, or PUBLIC_ACCESS
            const authBadge = document.getElementById(`${idPrefix}-auth-badge`);
            
            if(authStatus) {
                authBadge.classList.remove('hidden');
                if(authStatus === 'AUTHORIZED') {
                    authBadge.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-emerald-500 text-white animate-pulse";
                    authBadge.textContent = "ACCESS GRANTED";
                } else if(authStatus === 'DENIED') {
                    authBadge.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-rose-500 text-white";
                    authBadge.textContent = "ACCESS DENIED";
                    // Hide after 3 seconds
                    setTimeout(() => authBadge.classList.add('hidden'), 3000);
                } else {
                     authBadge.classList.add('hidden'); // Hide for public/normal state
                }
            }

            // --- BOOKING LOGIC ---
            const bookingRef = ref(db, `/EV/Bookings/${slotName}`);
            onValue(bookingRef, (bookSnap) => {
                const bookingData = bookSnap.val();
                const btn = document.getElementById(`${idPrefix}-book-btn`);
                const msg = document.getElementById(`${idPrefix}-booking-msg`);
                const isPhysicallyAvailable = data.IsAvailable === true;

                if (!isPhysicallyAvailable && data.IsAvailable !== undefined) {
                    btn.disabled = true;
                    btn.className = "w-full py-2.5 rounded-lg font-bold text-sm shadow-sm flex items-center justify-center gap-2 bg-slate-300 text-slate-500 cursor-not-allowed";
                    btn.innerHTML = `<i data-lucide="car" class="w-4 h-4"></i> Car Detected`;
                    msg.textContent = "Slot occupied by a vehicle";
                } else if (bookingData && bookingData.isBooked) {
                    const isMyBooking = bookingData.bookedBy === "User123"; // Simulating current user
                    if(isMyBooking) {
                        btn.disabled = false;
                        btn.className = "w-full py-2.5 rounded-lg font-bold text-sm shadow-sm flex items-center justify-center gap-2 bg-amber-500 hover:bg-amber-600 text-white active:scale-95";
                        btn.innerHTML = `<i data-lucide="x-circle" class="w-4 h-4"></i> Cancel My Booking`;
                        msg.textContent = "Reserved for you";
                        btn.onclick = () => window.cancelSlot(slotName);
                    } else {
                        btn.disabled = true;
                        btn.className = "w-full py-2.5 rounded-lg font-bold text-sm shadow-sm flex items-center justify-center gap-2 bg-rose-100 text-rose-600 border border-rose-200 cursor-not-allowed";
                        btn.innerHTML = `<i data-lucide="lock" class="w-4 h-4"></i> Reserved`;
                        msg.textContent = `Booked by ${bookingData.bookedBy}`;
                    }
                } else {
                    btn.disabled = false;
                    btn.className = "w-full py-2.5 rounded-lg font-bold text-sm shadow-sm transition-all flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white active:scale-95";
                    btn.innerHTML = `<i data-lucide="calendar-clock" class="w-4 h-4"></i> Book ${slotName}`;
                    msg.textContent = "Available for reservation";
                    // Important: Explicitly attaching the onclick handler
                    btn.onclick = () => window.bookSlot(slotName);
                }
                lucide.createIcons();
            });

            // --- SENSOR DATA LOGIC ---
            let rawVolts = parseFloat(data.Voltage || 0);
            let rawAmps = parseFloat(data.Current || 0);
            let rawPower = parseFloat(data.Power || 0);
            let rawSoC = parseInt(data.SoC || 0);

            if (rawAmps < -1.0) { rawAmps = 0; rawPower = 0; }
            if (rawVolts < VOLTAGE_THRESHOLD) { rawVolts = 0; rawAmps = 0; rawPower = 0; rawSoC = 0; }
            if (rawAmps < 0) rawAmps = 0;
            if (rawPower < 0) rawPower = 0;

            document.getElementById(`${idPrefix}-volts`).textContent = rawVolts.toFixed(2);
            document.getElementById(`${idPrefix}-current`).textContent = rawAmps.toFixed(2);
            document.getElementById(`${idPrefix}-power`).textContent = rawPower.toFixed(2);
            document.getElementById(`${idPrefix}-soc`).textContent = rawSoC;

            const badge = document.getElementById(`${idPrefix}-status-badge`);
            const isAvailable = data.IsAvailable === true;

            if (isAvailable) {
                badge.className = "mt-2 text-center px-3 py-2 rounded-lg text-xs font-bold uppercase tracking-wide bg-emerald-100 text-emerald-700";
                badge.innerHTML = `<i data-lucide="check-circle" class="w-3.5 h-3.5 inline"></i> <span>Empty</span>`;
            } else {
                if (rawVolts === 0 && rawAmps === 0) {
                      badge.className = "mt-2 text-center px-3 py-2 rounded-lg text-xs font-bold uppercase tracking-wide bg-amber-100 text-amber-700";
                      badge.innerHTML = `<i data-lucide="alert-circle" class="w-3.5 h-3.5 inline"></i> <span>Parked</span>`;
                } else {
                      badge.className = "mt-2 text-center px-3 py-2 rounded-lg text-xs font-bold uppercase tracking-wide bg-rose-100 text-rose-700";
                      badge.innerHTML = `<i data-lucide="car" class="w-3.5 h-3.5 inline"></i> <span>Charging</span>`;
                }
            }

            const fill = document.getElementById(`${idPrefix}-bat-fill`);
            const chargeIcon = document.getElementById(`${idPrefix}-charge-icon`);
            fill.style.height = `${rawSoC}%`;
            fill.classList.remove('bg-emerald-500', 'bg-amber-400', 'bg-red-500', 'bg-slate-400');
            
            if (rawVolts === 0) fill.classList.add('bg-slate-400');
            else if(rawSoC < 20) fill.classList.add('bg-red-500');
            else if(rawSoC < 50) fill.classList.add('bg-amber-400');
            else fill.classList.add('bg-emerald-500');

            const isCharging = !isAvailable && (rawAmps > 0.1);
            if(isCharging) chargeIcon.classList.remove('hidden');
            else chargeIcon.classList.add('hidden');

            lucide.createIcons();
        };

        // --- GLOBAL FUNCTIONS FOR BUTTONS ---
        window.bookSlot = (slotName) => {
            console.log(`Attempting to book: ${slotName}`);
            
            // Simple validation prompt
            const name = prompt("Enter Name for Booking:");
            if(!name) {
                console.log("Booking cancelled: No name entered");
                return;
            }
            
            // RFID UID Prompt
            const rfid = prompt("Enter your RFID Tag ID (HEX) to claim this spot:\n(Example: 34A2B1C9)");
            
            if(rfid) {
                set(ref(db, `/EV/Bookings/${slotName}`), {
                    isBooked: true,
                    bookedBy: name,
                    bookedUID: rfid.toUpperCase().trim(), // Store the UID
                    timestamp: Date.now()
                })
                .then(() => {
                    console.log("Booking successful!");
                    alert(`Slot ${slotName} successfully booked for ${name}.`);
                })
                .catch((error) => {
                    console.error("Booking failed: ", error);
                    alert("Failed to book slot. Check console for details.");
                });
            } else {
                 console.log("Booking cancelled: No RFID entered");
            }
        };

        window.cancelSlot = (slotName) => {
            if(confirm("Cancel this booking?")) {
                set(ref(db, `/EV/Bookings/${slotName}`), null);
            }
        };

        // --- LISTENERS ---
        onValue(ref(db, '/EV/Slot1'), (snap) => updateSlot('s1', snap.val(), 'Slot1'));
        onValue(ref(db, '/EV/Slot2'), (snap) => updateSlot('s2', snap.val(), 'Slot2'));

        onValue(ref(db, '/EV/ActiveSessions'), (snap) => {
            document.getElementById('session-count').textContent = snap.val() || 0;
        });

        const rfidContainer = document.getElementById('rfid-log-container');
        onValue(ref(db, '/EV/RFID/UID'), (snap) => {
            const uid = snap.val();
            if(uid && uid !== lastUid) {
                lastUid = uid;
                logCount++;
                if(rfidContainer.innerText.includes("Waiting")) rfidContainer.innerHTML = '';

                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const logEntry = document.createElement('div');
                logEntry.className = "flex items-center p-3 border-b border-slate-50 hover:bg-slate-50 transition-colors animate-fade-in-down";
                logEntry.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold mr-3">ID</div>
                    <div class="flex-1">
                        <p class="font-mono text-sm font-semibold text-slate-700">${uid}</p>
                        <p class="text-xs text-slate-400">${time}</p>
                    </div>
                    <div class="text-xs font-medium text-slate-600 bg-slate-100 px-2 py-1 rounded">Scanned</div>
                `;
                rfidContainer.insertBefore(logEntry, rfidContainer.firstChild);
                if(rfidContainer.children.length > MAX_LOGS) rfidContainer.removeChild(rfidContainer.lastChild);
                document.getElementById('log-count').textContent = `${Math.min(logCount, MAX_LOGS)}${logCount > MAX_LOGS ? '+' : ''} Events`;
            }
        });

    </script>
</body>
</html>
